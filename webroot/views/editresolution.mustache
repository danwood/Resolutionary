{{>header}}

{{! ASSUMES WE ARE AUTHENTICATED TO SEE THIS PAGE. }}


<h1>Edit a resolution</h1>

  <div class="container">

    <div class="row">
      <div class="six columns">

{{#resolutions}}

<h5><span>id: {{id}}</span></h5>
<h5><span>Creation: {{creationTimeStamp}}</span></h5>


<p>Board ID: <input name="boardID" value="{{boardID}}"  onkeyup='send(event)' /></p>
<p>author ID: <input name="authorID" value="{{authorID}}"  onkeyup='send(event)' /></p>

<p>notes about this resolution:</p>
<p><textarea id='notesMarkdown' name="notesMarkdown" cols="60" rows="5" onkeyup='send(event)'>{{{notesMarkdown}}}</textarea></p>

{{! FIXME: The textarea should be escaped, but then newlines get converted to BR tags in the textarea! }}

<div id='notesMarkdownRendered'></div>

{{/resolutions}}

{{#resolution_version}}

<p>Title: <input name="title" value="{{title}}"  onkeyup='send(event)' /></p>
<p>Co-Authors: <input name="coauthors" value="{{coauthors}}"  onkeyup='send(event)' /></p>

<p>Resolution Body:</p>
<p><textarea id='textMarkdown' name="textMarkdown" cols="60" rows="15" placeholder='WHEREAS …' onkeyup='send(event)'>{{{textMarkdown}}}</textarea></p>

{{! FIXME: The textarea should be escaped, but then newlines get converted to BR tags in the textarea! }}

<div id='textMarkdownRendered'></div>

{{/resolution_version}}
{{^resolution_version}}
<p>MISSING latest resolution version!</p>
{{/resolution_version}}


{{#resolution_versions}}

<h3>ID: <a href="/editresolution/{{resolutionID}}/{{id}}">{{id}}</a></h3>

{{! It would be nice to have a function to show an excerpt of what has been changed/added from a version relative to its previous version }}

{{/resolution_versions}}


      </div>
      <div class="three columns">
			<input type="button" value="Publish as new version" name="Publish" />
      </div>
    </div>
{{^resolutions}}
No resolutions…
{{/resolutions}}


  </div>






<script>

var sock;

function init()
{
	sock=new WebSocket('ws://' + window.location.host + '/editor{{#resolutions}}/{{id}}{{/resolutions}}', 'editor');		// ... API, PROTOCOL
	sock.onmessage=function(evt) {
		index = evt.data.indexOf("\n");			// Received data should be dest element ID, newline, then the HTML to put into it.
		destID = evt.data.substr(0, index);
		newValue = evt.data.substr(index+1);
		output = document.getElementById(destID);
		if (output) {
			output.innerHTML = newValue;
		} else {
			alert('Missing output ' + destID);
		}
	}
	sock.onopen = function() {
		// Maybe I could make this more generic, find all textAreas with Markdown and render
	var notesMarkdown = document.getElementById('notesMarkdown').innerHTML;
	sock.send("notesMarkdown\n" + notesMarkdown);
	var textMarkdown = document.getElementById('textMarkdown').innerHTML;
	sock.send("textMarkdown\n" + textMarkdown);
	};
}

var periodicTimer;	// Process, queued for a bit into the future, every N seconds, so when typing fast we see results frequently.
					// Note that hitting return sends text IMMEDIATELY for processing.
var evtTarget;		// Save event that timer is referring to

function send(evt) {

	if (13 == evt.keyCode) {				// If a newline, send it immediately.
		clearTimeout(periodicTimer);
		periodicTimer = null;
		sock.send(evt.currentTarget.name + '\n' + evt.currentTarget.value);
	} else {
		if (!periodicTimer) {

			evtTarget = evt.currentTarget;
			periodicTimer = setTimeout(function() {
				sock.send(evtTarget.name + '\n' + evtTarget.value);		// Send to server for immediate saving and possibly Markdown translation
				clearTimeout(periodicTimer);
				periodicTimer = null;
			}, 3000);
		}
	}
}

window.addEventListener('load', init, false);

</script>

{{>footer}}
